name: Desktop Release

on:
  release:
    types: [created]

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Desktop App
        working-directory: ./desktop
        run: |
          wails build -platform darwin/${{ matrix.arch }} -clean

      - name: Package App
        working-directory: ./desktop/build/bin
        run: |
          # Get version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="${{ matrix.arch }}"
          
          # Rename output to Walgo.app for consistency with install.sh
          # wails.json outputfilename is "desktop", so it creates "desktop.app"
          if [ -d "desktop.app" ]; then
            mv "desktop.app" "Walgo.app"
          fi
          
          TAR_NAME="walgo-desktop_${VERSION}_darwin_${ARCH}.tar.gz"
          
          echo "Packaging $TAR_NAME..."
          tar -czf "$TAR_NAME" "Walgo.app"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: desktop/build/bin/*.tar.gz
